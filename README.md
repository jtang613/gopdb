# gopdb

A pure Go library and CLI tool for parsing Microsoft PDB (Program Database) debug symbol files.

## Features

- **Pure Go implementation** - No CGO or external dependencies
- **MSVC PDB 7.00 format** - Supports PDB files generated by Visual Studio and MSVC toolchain
- **Function extraction** - Names, offsets, segments, lengths, and type signatures
- **Variable extraction** - Global and static variables with full type resolution
- **Type information** - Structs, classes, unions, enums with member details
- **Public symbols** - Exported symbol table access
- **Module information** - Compiled object file metadata
- **JSON output** - CLI tool outputs structured JSON for easy integration

## Installation

### Library

```bash
go get github.com/jtang613/gopdb
```

### CLI Tool

```bash
go install github.com/jtang613/gopdb/cmd/pdbdump@latest
```

Or build from source:

```bash
git clone https://github.com/jtang613/gopdb.git
cd gopdb
go build ./cmd/pdbdump
```

## CLI Usage

```bash
pdbdump [options] <pdb-file>
```

### Options

| Flag | Description |
|------|-------------|
| `-info` | Show PDB file information (GUID, age, machine type) |
| `-functions` | List all functions with signatures |
| `-variables` | List all global/static variables |
| `-types` | List all named types (structs, enums, etc.) |
| `-publics` | List all public symbols |
| `-modules` | List all compiled modules |
| `-all` | Show all information |
| `-pretty` | Pretty-print JSON output |
| `-type <index>` | Show details for a specific type index (hex supported: 0x1000) |

### Examples

```bash
# Show basic PDB information
pdbdump -info -pretty myapp.pdb

# List all functions
pdbdump -functions myapp.pdb

# List functions with pretty JSON
pdbdump -functions -pretty myapp.pdb | jq '.functions[:5]'

# Count functions
pdbdump -functions myapp.pdb | jq '.functions | length'

# Find functions by name pattern
pdbdump -functions myapp.pdb | jq '.functions[] | select(.name | contains("main"))'

# List variables with their types
pdbdump -variables -pretty myapp.pdb

# Show a specific type's details
pdbdump -type 0x1000 -pretty myapp.pdb

# Export everything to a file
pdbdump -all myapp.pdb > symbols.json
```

### Sample Output

```bash
$ pdbdump -info -pretty myapp.pdb
```

```json
{
  "info": {
    "guid": "D2B1E01153A9432AB2DA61A4A77FE2E2",
    "age": 3,
    "version": 20000404,
    "machine": "x86",
    "streams": 86,
    "named_streams": {
      "/LinkInfo": 5,
      "/names": 15
    }
  }
}
```

```bash
$ pdbdump -functions -pretty myapp.pdb | head -20
```

```json
{
  "functions": [
    {
      "name": "main",
      "offset": 4096,
      "segment": 1,
      "length": 256,
      "type_index": 4123,
      "signature": "int32 (int32, char**)",
      "is_global": true,
      "module": "main.obj"
    }
  ]
}
```

## Library API

### Opening a PDB File

```go
package main

import (
    "fmt"
    "log"

    "github.com/jtang613/gopdb/pkg/pdb"
)

func main() {
    p, err := pdb.Open("myapp.pdb")
    if err != nil {
        log.Fatal(err)
    }
    defer p.Close()

    // Get PDB info
    info := p.Info()
    fmt.Printf("GUID: %s\n", info.GUID)
    fmt.Printf("Machine: %s\n", info.Machine)
}
```

### Listing Functions

```go
functions := p.Functions()
for _, fn := range functions {
    fmt.Printf("%s at %d:%08x (len=%d)\n",
        fn.Name, fn.Segment, fn.Offset, fn.Length)
    fmt.Printf("  Signature: %s\n", fn.Signature)
}
```

### Listing Variables

```go
variables := p.Variables()
for _, v := range variables {
    fmt.Printf("%s: %s at %d:%08x\n",
        v.Name, v.TypeName, v.Segment, v.Offset)
}
```

### Working with Types

```go
// Get all named types
types := p.Types()
for _, t := range types {
    fmt.Printf("%s %s (size=%d)\n", t.Kind, t.Name, t.Size)
    for _, m := range t.Members {
        fmt.Printf("  +%d: %s %s\n", m.Offset, m.TypeName, m.Name)
    }
}

// Resolve a specific type by index
typeInfo := p.ResolveType(0x1000)
if typeInfo != nil {
    fmt.Printf("Type 0x1000: %s\n", typeInfo.Signature)
}
```

### Getting Module Information

```go
modules := p.Modules()
for _, mod := range modules {
    fmt.Printf("Module: %s\n", mod.Name)
    fmt.Printf("  Object: %s\n", mod.ObjectFile)
    fmt.Printf("  Symbol size: %d bytes\n", mod.SymbolSize)
}
```

## API Reference

### Types

#### `pdb.PDB`

Main PDB file handle.

```go
func Open(path string) (*PDB, error)
func (p *PDB) Close() error
func (p *PDB) Info() *PDBInfo
func (p *PDB) Functions() []Function
func (p *PDB) Variables() []Variable
func (p *PDB) Types() []TypeInfo
func (p *PDB) PublicSymbols() []PublicSymbol
func (p *PDB) Modules() []ModuleInfo
func (p *PDB) ResolveType(index uint32) *TypeInfo
func (p *PDB) TypeCount() int
```

#### `pdb.Function`

```go
type Function struct {
    Name      string // Function name
    Offset    uint32 // Code offset within segment
    Segment   uint16 // Code segment number
    Length    uint32 // Function length in bytes
    TypeIndex uint32 // Type index for signature
    Signature string // Resolved type signature
    IsGlobal  bool   // true for global, false for static
    Module    string // Source module name
}
```

#### `pdb.Variable`

```go
type Variable struct {
    Name      string // Variable name
    Offset    uint32 // Data offset within segment
    Segment   uint16 // Data segment number
    TypeIndex uint32 // Type index
    TypeName  string // Resolved type name
    IsGlobal  bool   // true for global, false for static
    Module    string // Source module name
}
```

#### `pdb.TypeInfo`

```go
type TypeInfo struct {
    Index     uint32   // Type index
    Kind      string   // "struct", "class", "union", "enum", "builtin", etc.
    Name      string   // Type name
    Size      uint64   // Size in bytes (for structs/unions)
    Signature string   // Full type signature
    Members   []Member // Struct/class/enum members
}
```

#### `pdb.Member`

```go
type Member struct {
    Name     string // Member name
    TypeName string // Member type
    Offset   uint64 // Offset within struct (or enum value)
}
```

#### `pdb.PDBInfo`

```go
type PDBInfo struct {
    GUID         string            // Unique identifier
    Age          uint32            // Build count
    Version      uint32            // PDB format version
    Machine      string            // Target architecture ("x86", "x64", "ARM", etc.)
    Streams      int               // Number of streams
    NamedStreams map[string]uint32 // Named stream indices
}
```

## Supported PDB Formats

| Format | Supported | Notes |
|--------|-----------|-------|
| MSVC PDB 7.00 | Yes | Visual Studio 2002+ |
| Portable PDB | No | .NET/Roslyn format (different specification) |
| PDB 2.0 | No | Legacy format (pre-VS2002) |

## Architecture

```
gopdb/
├── pkg/pdb/
│   ├── pdb.go           # High-level API
│   ├── types.go         # Exported types
│   ├── msf/             # MSF container layer
│   │   ├── msf.go       # Multi-Stream Format reader
│   │   ├── superblock.go# MSF header parsing
│   │   └── stream.go    # Non-contiguous block reader
│   ├── streams/         # PDB stream parsers
│   │   ├── pdbinfo.go   # Stream 1: PDB metadata
│   │   ├── tpi.go       # Stream 2: Type information
│   │   └── dbi.go       # Stream 3: Debug information
│   └── codeview/        # CodeView debug format
│       ├── symbols.go   # Symbol records (S_GPROC32, etc.)
│       └── types.go     # Type resolution (LF_STRUCTURE, etc.)
└── cmd/pdbdump/         # CLI tool
```

### Layers

1. **MSF Layer** - Parses the Multi-Stream Format container, handling block allocation and stream directory
2. **Stream Layer** - Parses individual PDB streams (PDB info, TPI, DBI, IPI)
3. **CodeView Layer** - Parses CodeView symbol and type records
4. **API Layer** - Provides high-level access to functions, variables, and types

## Limitations

- Read-only access (no PDB writing/modification)
- Portable PDB format not supported
- Line number information not yet exposed
- Some advanced CodeView records not fully parsed

## References

- [LLVM PDB Documentation](https://llvm.org/docs/PDB/index.html)
- [LLVM MSF File Format](https://llvm.org/docs/PDB/MsfFile.html)
- [Microsoft PDB Repository](https://github.com/microsoft/microsoft-pdb)
- [Microsoft pdb-rs (Rust)](https://github.com/microsoft/pdb-rs)

## License

MIT License
